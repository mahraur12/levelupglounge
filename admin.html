<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LEVELUPGAMING</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/valorant-icon.png">
    <style>
        .admin-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .dashboard {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* Table Styles */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            color: var(--text-main);
        }

        .admin-table th,
        .admin-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .rule-editor {
            width: 100%;
            min-height: 300px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 1.5rem;
            font-family: var(--font-body);
            font-size: 1.1rem;
            resize: vertical;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .rule-editor:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .admin-table th {
            background: rgba(0, 243, 255, 0.1);
            color: var(--neon-green);
            font-family: var(--font-display);
        }

        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .delete-btn {
            color: var(--neon-pink);
            background: none;
            border: 1px solid var(--neon-pink);
            padding: 5px 10px;
            cursor: pointer;
            font-family: var(--font-display);
        }

        .delete-btn:hover {
            background: var(--neon-pink);
            color: white;
        }

        /* Responsive Table */
        @media (max-width: 992px) {
            .admin-table thead {
                display: none;
            }

            .admin-table,
            .admin-table tbody,
            .admin-table tr,
            .admin-table td {
                display: block;
                width: 100%;
            }

            .admin-table tr {
                margin-bottom: 2rem;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid var(--glass-border);
                padding: 1rem;
                position: relative;
            }

            .admin-table td {
                text-align: right;
                padding: 0.8rem 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                position: relative;
                padding-left: 50%;
            }

            .admin-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 50%;
                padding-left: 0;
                font-weight: bold;
                text-align: left;
                color: var(--neon-green);
                font-family: var(--font-display);
                font-size: 0.8rem;
                text-transform: uppercase;
            }

            .admin-table td:last-child {
                border-bottom: none;
                padding-left: 0;
                text-align: center;
            }

            .admin-table td:last-child::before {
                display: none;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="loginScreen" class="admin-check">
        <h2 class="section-title">Admin <span class="text-neon-pink">Access</span></h2>
        <div class="form-group" style="width: 300px;">
            <input type="password" id="adminPass" class="form-control" placeholder="Enter Password"
                onkeyup="checkEnter(event)">
        </div>
        <button onclick="checkAdmin()" class="btn btn-primary">Unlock System</button>
        <p id="loginError" class="text-neon-pink" style="margin-top: 1rem; display: none;">Access Denied</p>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar" style="position: sticky;">
            <div class="container nav-content">
                <div class="logo">
                    <span class="text-neon-green">ADMIN</span> // DASHBOARD
                </div>
                <div class="nav-links">
                    <a href="index.html" target="_blank">View Site</a>
                    <a href="data.html" class="btn btn-sm">Data</a>
                    <button onclick="logout()" class="btn btn-sm">Logout</button>
                </div>
            </div>
        </nav>

        <section class="section">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>Registered Teams</h1>
                    <button onclick="clearData()"
                        style="color: var(--text-dim); background: none; border: none; cursor: pointer; text-decoration: underline;">Reset
                        Database</button>
                </div>

                <div class="cyber-card" style="margin-top: 2rem; overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Team Name</th>
                                <th>Captain</th>
                                <th>Discord</th>
                                <th>Payment</th>
                                <th>Roster (Name - ID - Rank - Contact)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                    <p id="noDataMsg" style="text-align: center; padding: 2rem; color: var(--text-dim); display: none;">
                        No registrations found locally.</p>
                </div>
            </div>
        </section>

        <!-- Rule Management Section -->
        <section class="section bg-darker">
            <div class="container">
                <h2 class="section-title">Rule <span class="text-neon-pink">Management</span></h2>
                <div class="cyber-card">
                    <p style="margin-bottom: 1rem; color: var(--text-dim);">Edit the tournament rule book here. Use line
                        breaks for formatting. These will appear on the Rule Book page.</p>
                    <textarea id="ruleEditor" class="rule-editor"
                        placeholder="Enter tournament rules here..."></textarea>
                    <div style="text-align: right;">
                        <button onclick="saveRules()" class="btn btn-primary">Save Rules</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" style="display: none;">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <img id="modalImg" class="modal-content">
    </div>

    <script>
        const AUTH_KEY = 'admin_session';

        // Check if already logged in
        if (sessionStorage.getItem(AUTH_KEY) === 'true') {
            showDashboard();
        }

        function checkEnter(e) {
            if (e.key === 'Enter') checkAdmin();
        }

        function checkAdmin() {
            const pass = document.getElementById('adminPass').value;
            // Simple client-side mock check
            if (pass === 'admin@1234') {
                sessionStorage.setItem(AUTH_KEY, 'true');
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'block';
            loadData();
            loadRules();
        }

        function loadRules() {
            const rules = localStorage.getItem('cafe_rules') || '';
            document.getElementById('ruleEditor').value = rules;
        }

        function saveRules() {
            const rules = document.getElementById('ruleEditor').value;
            localStorage.setItem('cafe_rules', rules);
            alert('Rules updated successfully!');
        }

        function logout() {
            sessionStorage.removeItem(AUTH_KEY);
            location.reload();
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('tournament_registrations') || '[]');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('noDataMsg').style.display = 'block';
                return;
            }

            document.getElementById('noDataMsg').style.display = 'none';

            data.forEach((team) => {
                // Handle legacy data (string array) vs new data (object array)
                let rosterDisplay = '';
                if (team.roster) {
                    rosterDisplay = team.roster.map(p => `${p.name} <span style="color:var(--neon-blue)">#${p.riotId || 'N/A'}</span> <span style="color:var(--neon-green)">[${p.rank || 'N/A'}]</span> <span style="color:var(--text-dim)">(${p.phone})</span>`).join('<br>');
                } else if (team.players) {
                    rosterDisplay = team.players.join(', '); // Backward compatibility
                }

                const paymentHtml = team.paymentScreenshot
                    ? `<button class="screenshot-btn" onclick="viewImage('${team.paymentScreenshot}')">View Proof</button>`
                    : '<span style="color:var(--text-dim)">None</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Time">${team.timestamp || 'N/A'}</td>
                    <td data-label="Team Name" class="text-neon-green" style="font-weight: bold;">${team.teamName}</td>
                    <td data-label="Captain">${team.captainEmail}</td>
                    <td data-label="Discord">${team.discord || '-'}</td>
                    <td data-label="Payment">${paymentHtml}</td>
                    <td data-label="Roster (Name - Rank - Contact)"><small>${rosterDisplay}</small></td>
                    <td>
                        <button onclick="updateStatus(${team.id}, 'verified')" class="btn btn-sm" style="color: var(--neon-green); border-color: var(--neon-green); margin-bottom: 5px;">Verified</button>
                        <button onclick="updateStatus(${team.id}, 'not_verified')" class="btn btn-sm" style="color: var(--neon-pink); border-color: var(--neon-pink);">Not Verified</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStatus(id, newStatus) {
            let data = JSON.parse(localStorage.getItem('tournament_registrations') || '[]');
            const index = data.findIndex(team => team.id === id);

            if (index !== -1) {
                data[index].status = newStatus;
                localStorage.setItem('tournament_registrations', JSON.stringify(data));
                if (newStatus === 'verified') alert('Team marked as VERIFIED.');
                else alert('Team marked as NOT VERIFIED.');
                loadData();
            }
        }


        function deleteTeam(id) {
            if (confirm('Delete this team?')) {
                let data = JSON.parse(localStorage.getItem('tournament_registrations') || '[]');
                // Filter out the team with the matching ID
                const initialLength = data.length;
                data = data.filter(team => team.id !== id);

                if (data.length === initialLength) {
                    alert('Error: Team not found (ID mismatch). Refreshing page.');
                } else {
                    localStorage.setItem('tournament_registrations', JSON.stringify(data));
                }
                loadData();
            }
        }

        function clearData() {
            if (confirm('WARNING: This will delete ALL registrations. Are you sure?')) {
                localStorage.removeItem('tournament_registrations');
                // Also try clearing everything to be safe if keys somehow drifted
                // localStorage.clear(); 
                loadData();
                alert('Database verified empty.');
            }
        }

        // Modal Functions
        function viewImage(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImg');
            img.src = src;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('imageModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>

</html>